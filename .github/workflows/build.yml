name: Build (Premake5)

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        configuration: [Debug, Release]

    env:
      PREMAKE_VERSION: 5.0.0-beta8

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Premake5 (download)
        shell: pwsh
        run: |
          $v   = "${env:PREMAKE_VERSION}"
          $zip = "premake-$v-windows.zip"
          $url = "https://github.com/premake/premake-core/releases/download/v$v/$zip"

          $dir = Join-Path $env:RUNNER_TEMP "premake"
          New-Item -ItemType Directory -Force -Path $dir | Out-Null

          Write-Host "Downloading: $url"
          Invoke-WebRequest -Uri $url -OutFile (Join-Path $dir $zip)

          Expand-Archive -Path (Join-Path $dir $zip) -DestinationPath $dir -Force

          $exe = Get-ChildItem -Path $dir -Recurse -Filter premake5.exe | Select-Object -First 1
          if (-not $exe) {
            Write-Host "Extracted contents:"
            Get-ChildItem -Path $dir -Recurse | Select-Object FullName
            throw "premake5.exe not found after extracting $zip"
          }

          $premakeBin = $exe.Directory.FullName

          # Make it available in *this* step
          $env:Path = "$premakeBin;$env:Path"

          # Make it available in subsequent steps
          $premakeBin | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

          premake5 --version

      - name: Generate Visual Studio 2022 files
        shell: pwsh
        run: premake5 vs2022

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Build solution (x64)
        shell: pwsh
        run: |
          $sln = Get-ChildItem -Path . -Filter *.sln | Select-Object -First 1
          if (-not $sln) { throw "No .sln found. Did premake5 vs2022 run successfully?" }

          msbuild $sln.FullName `
            /m `
            /p:Configuration=${{ matrix.configuration }} `
            /p:Platform=x64

      - name: Upload artifacts (.lib/.dll + headers)
        uses: actions/upload-artifact@v4
        with:
          name: HelloABI-${{ matrix.configuration }}-x64
          if-no-files-found: error
          path: |
            bin/x64/${{ matrix.configuration }}/static/**/*.lib
            bin/x64/${{ matrix.configuration }}/dynamic/**/*.dll
            bin/x64/${{ matrix.configuration }}/dynamic/**/*.lib
            bin/x64/${{ matrix.configuration }}/dynamic/**/*.pdb
            include/**/*.h
            include/**/*.hpp